{"metadata":{"guid":"b4910eb5-54e2-4cbb-9cd5-bfaccc5cb996","url":"/v2/streaming_pipelines/b4910eb5-54e2-4cbb-9cd5-bfaccc5cb996","created_at":"2018-02-22T21:28:44Z","updated_at":"2018-03-08T22:20:50Z","revision":1520547650244},"entity":{"name":"Time based billing app","description":"","project_guid":"e1f7733f-4898-45c8-8890-cff47001efd1","graph":{"doc_type":"pipeline","version":"1.0","json_schema":"http://www.ibm.com/ibm/wdp/flow-v1.0/pipeline-flow-v1-schema.json","id":"","app_data":{"ui_data":{"name":"Time based billing app"}},"primary_pipeline":"primary-pipeline","pipelines":[{"id":"primary-pipeline","runtime":"streams","nodes":[{"id":"watsoniot_eal8k1t93yu","type":"binding","op":"ibm.streams.sources.watsoniot","outputs":[{"id":"target","schema_ref":"schema0","links":[{"node_id_ref":"code_1hjin0isokb","port_id_ref":"source"}]}],"parameters":{"device_type":"Smart_Meters","event":"meter_readings","schema_mapping":[{"name":"device_id","type":"string","length":255,"path":"/device_id"},{"name":"firmware_version","type":"string","length":255,"path":"/firmware_version"},{"name":"usage_in_kwH","type":"double","path":"/usage_in_kwH"},{"name":"serial_number","type":"string","length":255,"path":"/serial_number"},{"name":"usage_date","type":"timestamp","path":"/usage_date"}]},"connection":{"ref":"471f2050-602e-408b-8daf-9d930d34990a","project_ref":"e1f7733f-4898-45c8-8890-cff47001efd1"},"app_data":{"ui_data":{"label":"WatsonIoT","x_pos":-2630,"y_pos":-60}}},{"id":"code_1hjin0isokb","type":"execution_node","op":"ibm.streams.operations.code","outputs":[{"id":"target","schema_ref":"schema1","links":[{"node_id_ref":"aggregate_ljzc9agzmd","port_id_ref":"source"},{"node_id_ref":"aggregate_597qcdsizz","port_id_ref":"source"}]}],"parameters":{"code":"#\n# YOU MUST EDIT THE SCHEMA and add all attributes that you are returning as output.\n#\n# Supported Python libraries are listed here:\n# https://datascience.ibm.com/docs/content/streaming-pipelines/python_libs.html?context=analytics\n\nimport sys\n  \nPEAK = 0\nMIDDAY = 1\nOFF_PEAK =2 \nMIDDAY_START = 12 #midday is from noon to 2pm\nMIDDAY_END = 14\nPEAK_START = 9 #9AM start for peak hours\nPEAK_END = 17  #5pm end for peak hours\n\nrates = {\n     PEAK : 14.5, MIDDAY : 11.5, OFF_PEAK: 9.5\n}\n    \n# init() function will be called once on pipeline initialization\n# @state a Python dictionary object for keeping state. The state object is passed to the process function\ndef init(state):\n    # do something once on pipeline initialization and save in the state object\n    #for our use case we will initialize the rates based on time of day\n    # this could be modified to retrieve from a database\n    pass\n\ndef get_usage_cost (hour_of_day, usage):\n    usage_code = OFF_PEAK\n\n    if (hour_of_day >= MIDDAY_START and hour_of_day <= MIDDAY_END ):\n       usage_code = MIDDAY\n    elif (hour_of_day >= PEAK_START and hour_of_day < PEAK_END):\n       usage_code = MIDDAY\n    cost =  (usage * rates[usage_code])/100\n    return cost\n    \n# process() function will be invoked on every event tuple\n# @event a Python dictionary object representing the input event tuple as defined by the input schema\n# @state a Python dictionary object for keeping state over subsequent function calls\n# return must be a Python dictionary object. It will be the output of this operator.\n#        Returning None results in not submitting an output tuple for this invocation.\n# You must declare all output attributes in the Edit Schema window.\n\ndef process(event, state):\n    # copy attributes from input to output\n    output = event\n    #next compute the cost of the usage based on the time of day\n    \n    usage = event[\"usage_in_kwH\"]\n    hour_of_day = event[\"usage_date\"].hour\n    \n    cost = get_usage_cost(hour_of_day, usage)\n        \n    # submit results as output: \n    output[\"cost\"] = cost\n    output[\"day\"] = str(event[\"usage_date\"].date())\n    output[\"hour_of_day\"] = hour_of_day \n    \n    return output","schema_mapping":[{"name":"cost","type":"double","length":0,"source_elem_name":"","target_elem_name":""},{"name":"hour_of_day","type":"double","length":0,"source_elem_name":"","target_elem_name":""},{"name":"day","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"device_id","type":"string","length":255},{"name":"firmware_version","type":"string","length":255},{"name":"usage_in_kwH","type":"double"},{"name":"serial_number","type":"string","length":255},{"name":"usage_date","type":"timestamp"}]},"app_data":{"ui_data":{"label":"Compute usage cost","x_pos":-2423,"y_pos":-60}}},{"id":"aggregate_ljzc9agzmd","type":"execution_node","op":"ibm.streams.operations.aggregate","outputs":[{"id":"target","schema_ref":"schema2","links":[{"node_id_ref":"freeform_filter_dzgl2oye1c6","port_id_ref":"source"}]}],"parameters":{"window_type":"sliding","window_time_unit":"day","window_number_of_time_units":"30","partition_by":"device_id","aggregation_output":[{"name":"running_total_cost","value":{"function":"Sum","type":"double","arguments":["cost"]},"type":""},{"name":"device_id","value":{"function":"Any","type":"varchar","arguments":["device_id"]},"type":""}],"schema_mapping":[{"name":"running_total_cost","type":"double"},{"name":"device_id","type":"string"}]},"app_data":{"ui_data":{"label":"Monthly total usage","x_pos":-2220,"y_pos":-90}}},{"id":"freeform_filter_dzgl2oye1c6","type":"execution_node","op":"ibm.streams.operations.freeform-filter","outputs":[{"id":"target","schema_ref":"schema3","links":[{"node_id_ref":"code_81bp6o73tx7","port_id_ref":"source"}]}],"parameters":{"expression":"running_total_cost > 200"},"app_data":{"ui_data":{"label":"Cost > 200","x_pos":-2008,"y_pos":-90}}},{"id":"code_81bp6o73tx7","type":"execution_node","op":"ibm.streams.operations.code","outputs":[{"id":"target","schema_ref":"schema4","links":[{"node_id_ref":"mail_ars5a1zn438","port_id_ref":"emailPort"},{"node_id_ref":"objectstorage_v2_c4gdhv8u83h","port_id_ref":"source"}]}],"parameters":{"code":"#\n# YOU MUST EDIT THE SCHEMA and add all attributes that you are returning as output.\n#\n# Supported Python libraries are listed here:\n# https://datascience.ibm.com/docs/content/streaming-pipelines/python_libs.html?context=analytics\n\nimport sys\nimport time\nimport ibm_db\n\n# Called once during initialization\ndef init(state): \n        creds =  {#PASTE DB2 CREDENTIALS HERE#\n        }\n        #Example: creds  = {\"port\": 5000}..etc\n        state[\"schema\"] = creds[\"username\"]\n        state[\"conn\"] = connect(creds)\n        state[\"notified\"] = []\n      \n# event - contains the tuple describing the meter and the total cost accrued so far\n# state - contains list of already notified users.\n   \ndef process(event, state):\n    notified_users = state[\"notified\"]\n\n    if event[\"device_id\"] not in notified_users:\n        meter_id = event[\"device_id\"]\n        output = get_customer_info(event, state)\n        state[\"notified\"].append(meter_id)\n        return output\n\n    else:\n        #have already notified this user, do nothing.\n        pass\n        \n        \n\n#retrieve contact info and add it to the output dictionary\n      \n      \ndef get_customer_info(event, state):        \n    \n    schema = state[\"schema\"] # if needed, change to schema name where tables were created\n    devices_table_name = schema + \".devices\"\n    customers_table_name  = schema + \".customers\"\n    select_statement = \"select C.ID,C.NAME,C.EMAIL, D.POSTALCODE from \"+ devices_table_name + \" D INNER JOIN  \" + customers_table_name + \" C ON D.CUSTOMER_ID = C.ID AND D.ID = (?);\"\n    stmt = ibm_db.prepare(state[\"conn\"], select_statement)\n    ibm_db.bind_param(stmt, 1, event[\"device_id\"])\n    ibm_db.execute(stmt)\n    \n    result = ibm_db.fetch_assoc(stmt)\n    if (result):\n        event[\"postalcode\"] = result[\"POSTALCODE\"]\n        event[\"name\"] =  result[\"NAME\"]\n        event[\"customer_id\"]  = result[\"ID\"]\n        event[\"email\"] = result[\"EMAIL\"]\n        event[\"threshold\"] = \"$200\"\n        event[\"running_total_cost\"] = round(event[\"running_total_cost\"],2)\n    return event\n\ndef connect(creds):\n    dsn_driver = \"IBM DB2 ODBC DRIVER\"\n    dsn_database = creds[\"db\"]            # e.g. \"BLUDB\"\n    dsn_hostname = creds[\"hostname\"]\n\n    dsn_port = creds[\"port\"]\n\n    dsn_protocol = \"TCPIP\"            # i.e. \"TCPIP\"\n    dsn_uid = creds[\"username\"]\n\n    dsn_pwd = creds[\"password\"]       # e.g. \"7dBZ3jWt9xN6$o0JiX!m\"\n    dsn = (\n        \"DRIVER={{IBM DB2 ODBC DRIVER}};\"\n        \"DATABASE={0};\"\n        \"HOSTNAME={1};\"\n        \"PORT={2};\"\n        \"PROTOCOL=TCPIP;\"\n        \"UID={3};\"\n        \"PWD={4};\").format(dsn_database, dsn_hostname, dsn_port, dsn_uid, dsn_pwd)\n    conn = ibm_db.connect(dsn, \"\", \"\")\n    return conn\n","schema_mapping":[{"name":"customer_id","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"email","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"name","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"postalcode","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"threshold","type":"string","length":0,"source_elem_name":"","target_elem_name":""},{"name":"running_total_cost","type":"double"},{"name":"device_id","type":"string"}]},"app_data":{"ui_data":{"label":"Get customer info","x_pos":-1785,"y_pos":-90}}},{"id":"mail_ars5a1zn438","type":"binding","op":"ibm.streams.targets.mail","parameters":{"smtp_server":"smtp.gmail.com","username":"you@gmail.com","sender":"alerts@acmeutility.com","recipients":"{{email}},you@gmail.com","subject_template":"Utility usage has exceeded {{threshold}}","message_template":"Dear {{name}},\nThis is an alert to inform you that your usage for your device {{device_id}} located at {{postalcode}} has incurred a total cost of ${{running_total_cost}}.\n\nYou can log in to the dashboard to view your usage by day and hour in order to determine high usage days and reduce costs.\n"},"app_data":{"ui_data":{"label":"Send high usage warning","x_pos":-1544,"y_pos":-62}}},{"id":"objectstorage_v2_c4gdhv8u83h","type":"binding","op":"ibm.streams.targets.objectstorage_v2","parameters":{"header_row_enabled":true,"write_policy":"fileSizeKB","rolling_file_size":"100"},"connection":{"ref":"9382c245-5f88-4e2b-a303-19d5bbcced23","project_ref":"e1f7733f-4898-45c8-8890-cff47001efd1","properties":{"asset":{"id":"/aggregatedemo/high_usage_alerts.txt","name":"/aggregatedemo/high_usage_alerts.txt","path":"/aggregatedemo/high_usage_alerts.txt","type":"unknown"}}},"app_data":{"ui_data":{"label":"Cloud Object Storage","x_pos":-1561,"y_pos":-166}}},{"id":"aggregate_597qcdsizz","type":"execution_node","op":"ibm.streams.operations.aggregate","outputs":[{"id":"target","schema_ref":"schema5","links":[{"node_id_ref":"dashdb_3ehr0i3nbiy","port_id_ref":"source"}]}],"parameters":{"window_time_unit":"hour","window_number_of_time_units":"1","partition_by":"device_id","group_by":"hour_of_day","aggregation_output":[{"name":"hour_of_day","value":{"function":"Any","type":"double","arguments":["hour_of_day"]},"type":""},{"name":"hourly_cost","value":{"function":"Sum","type":"double","arguments":["cost"]},"type":""},{"name":"day","value":{"function":"Any","type":"varchar","arguments":["day"]},"type":""},{"name":"device_id","value":{"function":"Any","type":"varchar","arguments":["device_id"]},"type":""}],"schema_mapping":[{"name":"hour_of_day","type":"double"},{"name":"hourly_cost","type":"double"},{"name":"day","type":"string"},{"name":"device_id","type":"string"}]},"app_data":{"ui_data":{"label":"Hourly total cost","x_pos":-2208,"y_pos":35}}},{"id":"dashdb_3ehr0i3nbiy","type":"binding","op":"ibm.streams.targets.dashdb","parameters":{"schema_mapping":[{"name":"hour_of_day","type":"double","target_elem_name":"HOUR"},{"name":"hourly_cost","type":"double","target_elem_name":"USAGE"},{"name":"day","type":"string","target_elem_name":"DATE"},{"name":"device_id","type":"string","target_elem_name":"DEVICE_ID"}]},"connection":{"ref":"ff13b45f-1279-42c0-9b45-5fd475aa6220","project_ref":"e1f7733f-4898-45c8-8890-cff47001efd1","properties":{"asset":{"id":"DEVICE_USAGE","type":"table","name":"DEVICE_USAGE","path":"/DASH7514/DEVICE_USAGE","asset_types":[],"assets":[],"fields":[{"name":"DEVICE_ID","type":{"type":"char","length":20,"scale":0,"nullable":false,"signed":false}},{"name":"DATE","type":{"type":"char","length":10,"scale":0,"nullable":false,"signed":false}},{"name":"HOUR","type":{"type":"smallint","length":5,"scale":0,"nullable":false,"signed":true}},{"name":"USAGE","type":{"type":"real","length":24,"scale":0,"nullable":true,"signed":true}}],"interaction_properties":{"schema_name":"DASH7514","table_name":"DEVICE_USAGE"},"extended_metadata":[],"first":{"href":"https://api.dataplatform.ibm.com/v2/connections/ff13b45f-1279-42c0-9b45-5fd475aa6220/assets?project_id=e1f7733f-4898-45c8-8890-cff47001efd1&offset=0&limit=10000&path=%2FDASH7514%2FDEVICE_USAGE&fetch=metadata%2Cinteraction&context=SOURCE"},"total_count":1,"logs":[],"columns":[{"name":"DEVICE_ID","type":{"type":"char","length":20,"scale":0,"nullable":false,"signed":false}},{"name":"DATE","type":{"type":"char","length":10,"scale":0,"nullable":false,"signed":false}},{"name":"HOUR","type":{"type":"smallint","length":5,"scale":0,"nullable":false,"signed":true}},{"name":"USAGE","type":{"type":"real","length":24,"scale":0,"nullable":true,"signed":true}}]}}},"app_data":{"ui_data":{"label":"Db2 Warehouse on Cloud","x_pos":-1991,"y_pos":38}}}]}],"schemas":[{"id":"schema0","fields":[{"name":"device_id","type":"string"},{"name":"firmware_version","type":"string"},{"name":"usage_in_kwH","type":"double"},{"name":"serial_number","type":"string"},{"name":"usage_date","type":"timestamp"}]},{"id":"schema1","fields":[{"name":"cost","type":"double"},{"name":"hour_of_day","type":"double"},{"name":"day","type":"string"},{"name":"device_id","type":"string"},{"name":"firmware_version","type":"string"},{"name":"usage_in_kwH","type":"double"},{"name":"serial_number","type":"string"},{"name":"usage_date","type":"timestamp"}]},{"id":"schema2","fields":[{"name":"running_total_cost","type":"double"},{"name":"device_id","type":"string"}]},{"id":"schema3","fields":[{"name":"running_total_cost","type":"double"},{"name":"device_id","type":"string"}]},{"id":"schema4","fields":[{"name":"customer_id","type":"string"},{"name":"email","type":"string"},{"name":"name","type":"string"},{"name":"postalcode","type":"string"},{"name":"threshold","type":"string"},{"name":"running_total_cost","type":"double"},{"name":"device_id","type":"string"}]},{"id":"schema5","fields":[{"name":"hour_of_day","type":"double"},{"name":"hourly_cost","type":"double"},{"name":"day","type":"string"},{"name":"device_id","type":"string"}]}]},"engines":{"streams":{"instance_id":"92626ba0-85a8-4973-8384-a72f81c85598","userPythonPackages":[]}}}}